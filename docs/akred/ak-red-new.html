<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>赤い人難易度表</title>
    <meta name="bmstable" content="./header.json" />
    <link href="style.css" rel="stylesheet" />

    <style>
      #table_int {
        width: 100%;
        margin: 0 auto;
        background-color: #000000;
        border-collapse: separate;
        border-spacing: 1px;
        border: 0;
      }

      #table_int td {
        padding: 2px;
      }

      .center-text {
        text-align: center;
      }
    </style>
  </head>
  <body class="diff">
    <div class="tableflame">
      <table id="table_int"></table>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const metaTag = document.querySelector("meta[name=bmstable]");
        if (!metaTag) return;

        getJSON(metaTag.getAttribute("content"), function (header) {
          getJSON(header.data_url, function (information) {
            makeBMSTable(information, header.symbol);
          });
        });
      });

      function getJSON(url, callback) {
        var req = new XMLHttpRequest();
        req.onload = function () {
          try {
            var data = JSON.parse(req.responseText);
            callback(data);
          } catch (e) {
            console.error("JSON Parse Error:", e);
          }
        };
        req.open("GET", url, true);
        req.send(null);
      }

      function makeBMSTable(info, mark) {
        var obj = document.getElementById("table_int");
        obj.innerHTML = "";

        var headerRow = document.createElement("tr");
        headerRow.style.height = "20px";
        headerRow.style.color = "white";
        headerRow.style.backgroundColor = "#666666";
        headerRow.innerHTML = `
            <td class="center-text">LV</td>
            <td class="center-text">タイトル</td>
            <td class="center-text">本体</td>
            <td class="center-text">差分</td>
            <td class="center-text">コメント</td>
        `;
        obj.appendChild(headerRow);

        var x = "";
        var count = 0;
        var obj_sep = null;

        for (var i = 0; i < info.length; i++) {
          if (x != info[i].level) {
            if (obj_sep != null) {
              obj_sep.innerHTML = `<td colspan='6' class="center-text"><b>${mark}${x} (${count}譜面)</b></td>`;
            }

            obj_sep = document.createElement("tr");
            obj_sep.className = "tr_separate";
            obj_sep.id = mark + info[i].level;
            obj.appendChild(obj_sep);

            count = 0;
            x = info[i].level;
          }

          var row = document.createElement("tr");

          if (info[i].state == 1) {
            row.className = "tr_new";
          } else if (info[i].state == 2) {
            row.className = "tr_update";
          } else {
            row.className = "tr_normal";
          }

          var astr = "";
          if (info[i].url) {
            if (info[i].artist) {
              astr = `<a href='${info[i].url}'>${info[i].artist}</a>`;
            } else {
              astr = `<a href='${info[i].url}'>${info[i].url}</a>`;
            }
          } else {
            if (info[i].artist) {
              astr = info[i].artist;
            }
          }

          if (info[i].url_pack) {
            if (info[i].name_pack) {
              astr += `<br />(<a href='${info[i].url_pack}'>${info[i].name_pack}</a>)`;
            } else {
              astr += `<br />(<a href='${info[i].url_pack}'>${info[i].url_pack}</a>)`;
            }
          } else {
            if (info[i].name_pack) {
              astr += `<br />(${info[i].name_pack})`;
            }
          }

          var diffStr = "";
          if (info[i].url_diff) {
            if (info[i].name_diff) {
              diffStr = `<a href='${info[i].url_diff}'>${info[i].name_diff}</a>`;
            } else {
              diffStr = `<a href='${info[i].url_diff}'>${info[i].url_diff}</a>`;
            }
          } else {
            if (info[i].name_diff) {
              diffStr = info[i].name_diff;
            }
          }

          row.innerHTML = `
            <td style='width: 5%'>${mark}${x}</td>
            <td style='width: 20%'><a href='http://www.dream-pro.info/~lavalse/LR2IR/search.cgi?mode=ranking&bmsmd5=${info[i].md5}' target='_blank'>${info[i].title}</a></td>
            <td style='width: 20%'>${astr}</td>
            <td style='width: 10%'>${diffStr}</td>
            <td style='width: 15%'>${info[i].comment}</td>
          `;

          obj.appendChild(row);
          count++;
        }

        if (obj_sep != null) {
          obj_sep.innerHTML = `<td colspan='6' class="center-text"><b>${mark}${x} (${count}譜面)</b></td>`;
        }
      }
    </script>
  </body>
</html>
